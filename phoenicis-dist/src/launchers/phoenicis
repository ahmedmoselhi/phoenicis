#!/bin/bash

set -e

APP_HOME="/usr/share/phoenicis"

for launcher in \
    "$APP_HOME/phoenicis-playonlinux" \
    "$APP_HOME/bin/phoenicis-playonlinux" \
    "$APP_HOME/bin/Phoenicis PlayOnLinux" \
    "$APP_HOME/PhoenicisPlayOnLinux"; do
    if [ -x "$launcher" ]; then
        exec "$launcher" "$@"
    fi
done

for candidate in \
    "$APP_HOME/lib/runtime/bin/java" \
    "$APP_HOME/runtime/bin/java"; do
    if [ -x "$candidate" ]; then
        JAVA_BIN="$candidate"
        break
    fi
done

JAVA_BIN="${JAVA_BIN:-java}"

MODULE_PATH="$APP_HOME/lib"
if [ -d "$APP_HOME/lib/app" ]; then
    MODULE_PATH="$MODULE_PATH:$APP_HOME/lib/app"
fi

if compgen -G "$APP_HOME/lib/app/*.jar" > /dev/null || compgen -G "$APP_HOME/lib/*.jar" > /dev/null; then
    MODULES="jdk.crypto.ec,java.base,javafx.base,javafx.controls,javafx.fxml,javafx.graphics,javafx.media,javafx.web,java.management,java.naming,java.scripting,java.sql,jdk.internal.vm.ci,jdk.internal.vm.compiler,jdk.jsobject,jdk.xml.dom,org.graalvm.truffle"
    JAVA_ARGS=(
        "--add-modules=$MODULES"
        "--module-path" "$MODULE_PATH"
        "--upgrade-module-path=$APP_HOME/lib/compiler.jar:$APP_HOME/lib/app/compiler.jar"
        "-cp" "$APP_HOME/lib/app/*:$APP_HOME/lib/*"
        "org.phoenicis.javafx.JavaFXApplication"
    )

    if "$JAVA_BIN" --help 2>&1 | grep -q -- "--enable-native-access"; then
        JAVA_ARGS=("--enable-native-access=javafx.graphics" "${JAVA_ARGS[@]}")
    fi

    exec "$JAVA_BIN" "${JAVA_ARGS[@]}" "$@"
fi

echo "Unable to find a runnable Phoenicis launcher in $APP_HOME" >&2
exit 1
